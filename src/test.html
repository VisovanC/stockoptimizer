<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Optimizer Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        input, button {
            padding: 10px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        .result {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            border-left: 4px solid #007bff;
        }
        .error {
            border-left-color: #dc3545;
            background-color: #ffe6e6;
        }
        .success {
            border-left-color: #28a745;
            background-color: #e6ffe6;
        }
        .debug {
            font-family: monospace;
            font-size: 12px;
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
<h1>Stock Portfolio Optimizer - API Test</h1>

<!-- Basic Connectivity -->
<div class="container">
    <h2>0. Basic Connectivity</h2>
    <button onclick="testPing()">Test Ping</button>
    <button onclick="testServer()">Test Server Root</button>
    <div id="pingResult" class="result" style="display:none;"></div>
</div>

<!-- Health Check -->
<div class="container">
    <h2>1. Health Check</h2>
    <button onclick="checkHealth()">Check MongoDB Health</button>
    <div id="healthResult" class="result" style="display:none;"></div>
</div>

<!-- Sign Up -->
<div class="container">
    <h2>2. Sign Up</h2>
    <input type="text" id="signupUsername" placeholder="Username" value="testuser123">
    <input type="email" id="signupEmail" placeholder="Email" value="test123@example.com">
    <input type="password" id="signupPassword" placeholder="Password" value="password123">
    <button onclick="signUp()">Sign Up</button>
    <div id="signupResult" class="result" style="display:none;"></div>
</div>

<!-- Sign In -->
<div class="container">
    <h2>3. Sign In</h2>
    <input type="text" id="loginUsername" placeholder="Username" value="testuser123">
    <input type="password" id="loginPassword" placeholder="Password" value="password123">
    <button onclick="signIn()">Sign In</button>
    <div id="loginResult" class="result" style="display:none;"></div>
</div>

<!-- Protected Test -->
<div class="container">
    <h2>4. Test Protected Endpoint</h2>
    <button onclick="testProtected()">Get Portfolios (Protected)</button>
    <div id="protectedResult" class="result" style="display:none;"></div>
</div>

<!-- Debug Info -->
<div class="container">
    <h2>5. Debug Information</h2>
    <button onclick="getDebugInfo()">Get All Users (Debug)</button>
    <div id="debugResult" class="result" style="display:none;"></div>
</div>

<script>
    const API_BASE = 'http://localhost:8080/api';
    let token = '';

    function showResult(elementId, message, isError = false, isSuccess = false) {
        const element = document.getElementById(elementId);
        element.style.display = 'block';
        element.className = `result ${isError ? 'error' : isSuccess ? 'success' : ''}`;
        element.innerHTML = message;
    }

    async function testPing() {
        try {
            console.log('Testing ping...');
            const response = await fetch(`${API_BASE}/test/ping`);
            const data = await response.json();

            if (response.ok) {
                showResult('pingResult', `✓ Ping OK: ${data.message} (${data.status})`, false, true);
            } else {
                showResult('pingResult', `✗ Ping Error: ${response.status}`, true);
            }
        } catch (error) {
            console.error('Ping error:', error);
            showResult('pingResult', `✗ Network Error: ${error.message}`, true);
        }
    }

    async function testServer() {
        try {
            console.log('Testing server root...');
            const response = await fetch('http://localhost:8080/');
            console.log('Server response status:', response.status);

            if (response.ok) {
                showResult('pingResult', `✓ Server responding: ${response.status}`, false, true);
            } else {
                showResult('pingResult', `✗ Server Error: ${response.status}`, true);
            }
        } catch (error) {
            console.error('Server test error:', error);
            showResult('pingResult', `✗ Server not accessible: ${error.message}`, true);
        }
    }

    async function checkHealth() {
        try {
            console.log('Checking health...');
            const response = await fetch(`${API_BASE}/health/mongodb`);
            const data = await response.json();

            if (response.ok) {
                showResult('healthResult', `✓ Health OK: ${data.status}`, false, true);
            } else {
                showResult('healthResult', `✗ Health Error: ${data.message || 'Unknown error'}`, true);
            }
        } catch (error) {
            showResult('healthResult', `✗ Network Error: ${error.message}`, true);
        }
    }

    async function signUp() {
        const username = document.getElementById('signupUsername').value;
        const email = document.getElementById('signupEmail').value;
        const password = document.getElementById('signupPassword').value;

        console.log('Signing up:', { username, email, password: '***' });

        try {
            const response = await fetch(`${API_BASE}/auth/signup`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ username, email, password })
            });

            const data = await response.json();
            console.log('Signup response:', data);

            if (response.ok) {
                showResult('signupResult', `✓ Signup successful: ${data.message}`, false, true);
                // Auto-fill login form
                document.getElementById('loginUsername').value = username;
                document.getElementById('loginPassword').value = password;
            } else {
                showResult('signupResult', `✗ Signup failed: ${data.message}`, true);
            }
        } catch (error) {
            showResult('signupResult', `✗ Network Error: ${error.message}`, true);
        }
    }

    async function signIn() {
        const username = document.getElementById('loginUsername').value;
        const password = document.getElementById('loginPassword').value;

        console.log('Signing in:', { username, password: '***' });

        try {
            const response = await fetch(`${API_BASE}/auth/signin`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ username, password })
            });

            const data = await response.json();
            console.log('Login response:', response.status, data);

            if (response.ok && data.token) {
                token = data.token;
                showResult('loginResult', `✓ Login successful! Token: ${token.substring(0, 30)}...`, false, true);
            } else {
                showResult('loginResult', `✗ Login failed: ${data.message || 'Unknown error'}`, true);
            }
        } catch (error) {
            console.error('Login error:', error);
            showResult('loginResult', `✗ Network Error: ${error.message}`, true);
        }
    }

    async function testProtected() {
        if (!token) {
            showResult('protectedResult', '✗ Please login first to get a token', true);
            return;
        }

        console.log('Testing protected endpoint with token:', token.substring(0, 30) + '...');

        try {
            const response = await fetch(`${API_BASE}/portfolios`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                }
            });

            console.log('Protected response status:', response.status);

            if (response.ok) {
                const data = await response.json();
                showResult('protectedResult', `✓ Protected endpoint works! Found ${data.length} portfolios`, false, true);
            } else {
                const errorData = await response.text();
                showResult('protectedResult', `✗ Protected endpoint failed (${response.status}): ${errorData}`, true);
            }
        } catch (error) {
            showResult('protectedResult', `✗ Network Error: ${error.message}`, true);
        }
    }

    async function getDebugInfo() {
        try {
            const response = await fetch(`${API_BASE}/auth/debug/users`);
            const data = await response.json();

            if (response.ok) {
                const debugInfo = data.map(user => ({
                    username: user.username,
                    email: user.email,
                    enabled: user.enabled,
                    roles: user.roles,
                    passwordHash: user.password?.substring(0, 20) + '...'
                }));

                showResult('debugResult', `✓ Found ${data.length} users:\n${JSON.stringify(debugInfo, null, 2)}`, false, true);
            } else {
                showResult('debugResult', `✗ Debug info failed: ${data.message}`, true);
            }
        } catch (error) {
            showResult('debugResult', `✗ Network Error: ${error.message}`, true);
        }
    }

    // Auto-generate random test data
    function generateTestData() {
        const random = Math.floor(Math.random() * 10000);
        document.getElementById('signupUsername').value = `testuser${random}`;
        document.getElementById('signupEmail').value = `test${random}@example.com`;
        document.getElementById('loginUsername').value = `testuser${random}`;
    }

    // Generate test data on page load
    generateTestData();
</script>
</body>
</html>